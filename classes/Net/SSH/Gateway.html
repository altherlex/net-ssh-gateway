<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang='en'>
  <head>
    <title>Net::SSH::Gateway</title>
    <meta content='text/html; charset=US-ASCII' http-equiv='Content-Type'>
    <link href='../../../css/style.css' media='screen' rel='stylesheet' type='text/css'>
    <script type='text/javascript'>
      //<![CDATA[
        function popupCode(url) {
          window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
        }
        
        function toggleCode(id) {
          var code = document.getElementById(id)
        
          code.style.display = code.style.display != 'block' ? 'block' : 'none'
          return true
        }
        
        // Make codeblocks hidden by default
        document.writeln('<' + 'style type="text/css">.method .source pre { display: none }<\/style>')
      //]]>
    </script>
  </head>
  <body class='page'>
    <div class='class' id='wrapper'>
      <div class='header'>
        <h1 class='name'>
          <span class='type'>class</span>
          Net::SSH::Gateway
        </h1>
        <ol class='paths'>
          <li>
            <a target="docwin" href="../../../files/lib/net/ssh/gateway_rb.html">lib/net/ssh/gateway.rb</a>
          </li>
        </ol>
        <div class='parent'>
          Parent:
          <strong><a target="docwin" href="../SSH.html">SSH</a></strong>
        </div>
      </div>
      <div id='content'>
        <div id='text'>
          <div id='description'>
            
            <p>A <a href="Gateway.html">Gateway</a> is an object that allows you to tunnel
            network connections through a publicly visible host to a host hidden behind
            it. This is particularly useful when dealing with hosts behind a firewall.
            One host will generally be visible (and accessible) outside the firewall,
            while the others will all be behind the firewall, and the only way to
            access those restricted hosts is by first logging into the publicly visible
            host, and from thence logging into the restricted ones.</p>
            
            <p>This class makes it easy to programmatically connect to these restricted
            hosts via <a href="../SSH.html">SSH</a>. You can either simply forward a
            port from the local host to the remote host, or you can open a new <a
            href="../SSH.html">Net::SSH</a> connection to the remote host via a
            forwarded port.</p>
            
            <pre class="ruby"><span class="ruby-identifier">require</span> <span class="ruby-string">'net/ssh/gateway'</span>&#x000A;&#x000A;<span class="ruby-identifier">gateway</span> = <span class="ruby-constant">Net</span><span class="ruby-operator">::</span><span class="ruby-constant">SSH</span><span class="ruby-operator">::</span><span class="ruby-constant">Gateway</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">'host.name'</span>, <span class="ruby-string">'user'</span>)&#x000A;&#x000A;<span class="ruby-identifier">gateway</span>.<span class="ruby-identifier">open</span>(<span class="ruby-string">'hidden.host'</span>, <span class="ruby-value">80</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">port</span><span class="ruby-operator">|</span>&#x000A;  <span class="ruby-constant">Net</span><span class="ruby-operator">::</span><span class="ruby-constant">HTTP</span>.<span class="ruby-identifier">get_print</span> <span class="ruby-string">'127.0.0.1'</span>, <span class="ruby-string">'/path'</span>, <span class="ruby-identifier">port</span>&#x000A;<span class="ruby-keyword">end</span>&#x000A;&#x000A;<span class="ruby-identifier">gateway</span>.<span class="ruby-identifier">ssh</span>(<span class="ruby-string">'hidden.host'</span>, <span class="ruby-string">'user'</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">ssh</span><span class="ruby-operator">|</span>&#x000A;  <span class="ruby-identifier">puts</span> <span class="ruby-identifier">ssh</span>.<span class="ruby-identifier">exec!</span>(<span class="ruby-string">&quot;hostname&quot;</span>)&#x000A;<span class="ruby-keyword">end</span>&#x000A;&#x000A;<span class="ruby-identifier">gateway</span>.<span class="ruby-identifier">shutdown!</span></pre>
            
            <p>Port numbers are allocated automatically, beginning at <a
            href="Gateway.html#MAX_PORT">MAX_PORT</a> and decrementing on each request
            for a new port until <a href="Gateway.html#MIN_PORT">MIN_PORT</a> is
            reached. If a port is already in use, this is detected and a different port
            will be assigned.</p>
          </div>
          <div id='method-list'>
            <h2>Methods</h2>
            <h3>Public Class</h3>
            <ol>
              <li><a target="docwin" href="#method-c-new">new</a></li>
            </ol>
            <h3>Public Instance</h3>
            <ol>
              <li><a target="docwin" href="#method-i-active-3F">active?</a></li>
              <li><a target="docwin" href="#method-i-close">close</a></li>
              <li><a target="docwin" href="#method-i-open">open</a></li>
              <li><a target="docwin" href="#method-i-shutdown-21">shutdown!</a></li>
              <li><a target="docwin" href="#method-i-ssh">ssh</a></li>
            </ol>
          </div>
          <div id='context'>
          </div>
          <div id='class-list'>
            <h2>Classes and Modules</h2>
            <ol>
              <li><a target="docwin" href="Gateway/Version.html">Net::SSH::Gateway::Version</a></li>
            </ol>
          </div>
          <div id='section'>
            <div id='constants-list'>
              <h2>Constants</h2>
              <div class='name-list'>
                <table summary='Constants'>
                  <tr class='top-aligned-row context-row'>
                    <td class='context-item-name'>MAX_PORT</td>
                    <td>=</td>
                    <td class='context-item-value'>65535</td>
                    <td>&nbsp;</td>
                    <td class='context-item-desc'>
                      
                      <p>The maximum port number that the gateway will attempt to use to forward
                      connections from.</p>
                    </td>
                  </tr>
                  <tr class='top-aligned-row context-row'>
                    <td class='context-item-name'>MIN_PORT</td>
                    <td>=</td>
                    <td class='context-item-value'>1024</td>
                    <td>&nbsp;</td>
                    <td class='context-item-desc'>
                      
                      <p>The minimum port number that the gateway will attempt to use to forward
                      connections from.</p>
                    </td>
                  </tr>
                </table>
              </div>
            </div>
            <div id='methods'>
              <h2>Public Class methods</h2>
              <div class='method public-class' id='method-method-c-new'>
                <a name='method-c-new'></a>
                <div class='synopsis'>
                  <span class='name'>new</span>
                  <span class='arguments'>(host, user, options={})</span>
                </div>
                <div class='description'>
                  
                  <p>Instantiate a new <a href="Gateway.html">Gateway</a> object, using the
                  given remote host as the tunnel. The arguments here are identical to those
                  for Net::SSH.start, and are passed as given to that method to start up the
                  gateway connection.</p>
                  
                  <pre class="ruby"><span class="ruby-identifier">gateway</span> = <span class="ruby-constant">Net</span><span class="ruby-operator">::</span><span class="ruby-constant">SSH</span><span class="ruby-operator">::</span><span class="ruby-constant">Gateway</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">'host'</span>, <span class="ruby-string">'user'</span>, :<span class="ruby-identifier">password</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;password&quot;</span>)</pre>
                  
                  <p>As of 1.1 there is an additional option to specify the wait time for  the
                  gateway thread. The default is 0.001 seconds and can be changed with the
                  :loop_wait option.</p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('method-c-new-source'); return false">
                    [show source]
                  </a>
                  <pre id='method-c-new-source'><span class="ruby-comment"># File lib/net/ssh/gateway.rb, line 73</span>&#x000A;<span class="ruby-keyword">def</span> <span class="ruby-identifier">initialize</span>(<span class="ruby-identifier">host</span>, <span class="ruby-identifier">user</span>, <span class="ruby-identifier">options</span>={})&#x000A;  <span class="ruby-ivar">@session</span> = <span class="ruby-constant">Net</span><span class="ruby-operator">::</span><span class="ruby-constant">SSH</span>.<span class="ruby-identifier">start</span>(<span class="ruby-identifier">host</span>, <span class="ruby-identifier">user</span>, <span class="ruby-identifier">options</span>)&#x000A;  <span class="ruby-ivar">@session_mutex</span> = <span class="ruby-constant">Mutex</span>.<span class="ruby-identifier">new</span>&#x000A;  <span class="ruby-ivar">@port_mutex</span> = <span class="ruby-constant">Mutex</span>.<span class="ruby-identifier">new</span>&#x000A;  <span class="ruby-ivar">@next_port</span> = <span class="ruby-constant">MAX_PORT</span>&#x000A;  <span class="ruby-ivar">@loop_wait</span> = <span class="ruby-identifier">options</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-value">:loop_wait</span>) <span class="ruby-operator">||</span> <span class="ruby-value">0.001</span>&#x000A;  <span class="ruby-identifier">initiate_event_loop!</span>&#x000A;<span class="ruby-keyword">end</span></pre>
                </div>
              </div>
              <h2>Public Instance methods</h2>
              <div class='method public-instance' id='method-method-i-active-3F'>
                <a name='method-i-active-3F'></a>
                <div class='synopsis'>
                  <span class='name'>active?</span>
                  <span class='arguments'>()</span>
                </div>
                <div class='description'>
                  
                  <p>Returns <code>true</code> if the gateway is currently open and accepting
                  connections. This will be the case unless <a
                  href="Gateway.html#method-i-shutdown-21">shutdown!</a> has been invoked.</p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('method-i-active-3F-source'); return false">
                    [show source]
                  </a>
                  <pre id='method-i-active-3F-source'><span class="ruby-comment"># File lib/net/ssh/gateway.rb, line 84</span>&#x000A;<span class="ruby-keyword">def</span> <span class="ruby-identifier">active?</span>&#x000A;  <span class="ruby-ivar">@active</span>&#x000A;<span class="ruby-keyword">end</span></pre>
                </div>
              </div>
              <div class='method public-instance' id='method-method-i-close'>
                <a name='method-i-close'></a>
                <div class='synopsis'>
                  <span class='name'>close</span>
                  <span class='arguments'>(port)</span>
                </div>
                <div class='description'>
                  
                  <p>Cancels port-forwarding over an open port that was previously opened via <a
                  href="Gateway.html#method-i-open">open</a>.</p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('method-i-close-source'); return false">
                    [show source]
                  </a>
                  <pre id='method-i-close-source'><span class="ruby-comment"># File lib/net/ssh/gateway.rb, line 146</span>&#x000A;<span class="ruby-keyword">def</span> <span class="ruby-identifier">close</span>(<span class="ruby-identifier">port</span>)&#x000A;  <span class="ruby-identifier">ensure_open!</span>&#x000A;&#x000A;  <span class="ruby-ivar">@session_mutex</span>.<span class="ruby-identifier">synchronize</span> <span class="ruby-keyword">do</span>&#x000A;    <span class="ruby-ivar">@session</span>.<span class="ruby-identifier">forward</span>.<span class="ruby-identifier">cancel_local</span>(<span class="ruby-identifier">port</span>)&#x000A;  <span class="ruby-keyword">end</span>&#x000A;<span class="ruby-keyword">end</span></pre>
                </div>
              </div>
              <div class='method public-instance' id='method-method-i-open'>
                <a name='method-i-open'></a>
                <div class='synopsis'>
                  <span class='name'>open</span>
                  <span class='arguments'>(host, port, local_port=nil)</span>
                </div>
                <div class='description'>
                  
                  <p>Opens a new port on the local host and forwards it to the given host/port
                  via the gateway host. If a block is given, the newly allocated port number
                  will be yielded to the block, and the port automatically closed (see <a
                  href="Gateway.html#method-i-close">close</a>) when the block finishes.
                  Otherwise, the port number will be returned, and the caller is responsible
                  for closing the port (<a href="Gateway.html#method-i-close">close</a>).</p>
                  
                  <pre class="ruby"><span class="ruby-identifier">gateway</span>.<span class="ruby-identifier">open</span>(<span class="ruby-string">'host'</span>, <span class="ruby-value">80</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">port</span><span class="ruby-operator">|</span>&#x000A;  <span class="ruby-comment"># ...</span>&#x000A;<span class="ruby-keyword">end</span>&#x000A;&#x000A;<span class="ruby-identifier">port</span> = <span class="ruby-identifier">gateway</span>.<span class="ruby-identifier">open</span>(<span class="ruby-string">'host'</span>, <span class="ruby-value">80</span>)&#x000A;<span class="ruby-comment"># ...</span>&#x000A;<span class="ruby-identifier">gateway</span>.<span class="ruby-identifier">close</span>(<span class="ruby-identifier">port</span>)</pre>
                  
                  <p>If <code>local_port</code> is not specified, the next available port will
                  be used.</p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('method-i-open-source'); return false">
                    [show source]
                  </a>
                  <pre id='method-i-open-source'><span class="ruby-comment"># File lib/net/ssh/gateway.rb, line 121</span>&#x000A;<span class="ruby-keyword">def</span> <span class="ruby-identifier">open</span>(<span class="ruby-identifier">host</span>, <span class="ruby-identifier">port</span>, <span class="ruby-identifier">local_port</span>=<span class="ruby-keyword">nil</span>)&#x000A;  <span class="ruby-identifier">ensure_open!</span>&#x000A;&#x000A;  <span class="ruby-identifier">actual_local_port</span> = <span class="ruby-identifier">local_port</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">next_port</span>&#x000A;&#x000A;  <span class="ruby-ivar">@session_mutex</span>.<span class="ruby-identifier">synchronize</span> <span class="ruby-keyword">do</span>&#x000A;    <span class="ruby-ivar">@session</span>.<span class="ruby-identifier">forward</span>.<span class="ruby-identifier">local</span>(<span class="ruby-identifier">actual_local_port</span>, <span class="ruby-identifier">host</span>, <span class="ruby-identifier">port</span>)&#x000A;  <span class="ruby-keyword">end</span>&#x000A;&#x000A;  <span class="ruby-keyword">if</span> <span class="ruby-identifier">block_given?</span>&#x000A;    <span class="ruby-keyword">begin</span>&#x000A;      <span class="ruby-keyword">yield</span> <span class="ruby-identifier">actual_local_port</span>&#x000A;    <span class="ruby-keyword">ensure</span>&#x000A;      <span class="ruby-identifier">close</span>(<span class="ruby-identifier">actual_local_port</span>)&#x000A;    <span class="ruby-keyword">end</span>&#x000A;  <span class="ruby-keyword">else</span>&#x000A;    <span class="ruby-keyword">return</span> <span class="ruby-identifier">actual_local_port</span>&#x000A;  <span class="ruby-keyword">end</span>&#x000A;<span class="ruby-keyword">rescue</span> <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">EADDRINUSE</span>&#x000A;  <span class="ruby-identifier">raise</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">local_port</span> <span class="ruby-comment"># if a local port was explicitly requested, bubble the error up</span>&#x000A;  <span class="ruby-keyword">retry</span>&#x000A;<span class="ruby-keyword">end</span></pre>
                </div>
              </div>
              <div class='method public-instance' id='method-method-i-shutdown-21'>
                <a name='method-i-shutdown-21'></a>
                <div class='synopsis'>
                  <span class='name'>shutdown!</span>
                  <span class='arguments'>()</span>
                </div>
                <div class='description'>
                  
                  <p>Shuts down the gateway by closing all forwarded ports and then closing the
                  gateway's <a href="../SSH.html">SSH</a> session.</p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('method-i-shutdown-21-source'); return false">
                    [show source]
                  </a>
                  <pre id='method-i-shutdown-21-source'><span class="ruby-comment"># File lib/net/ssh/gateway.rb, line 90</span>&#x000A;<span class="ruby-keyword">def</span> <span class="ruby-identifier">shutdown!</span>&#x000A;  <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">active?</span>&#x000A;&#x000A;  <span class="ruby-ivar">@session_mutex</span>.<span class="ruby-identifier">synchronize</span> <span class="ruby-keyword">do</span>&#x000A;    <span class="ruby-comment"># cancel all active forward channels</span>&#x000A;    <span class="ruby-ivar">@session</span>.<span class="ruby-identifier">forward</span>.<span class="ruby-identifier">active_locals</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">lport</span>, <span class="ruby-identifier">host</span>, <span class="ruby-identifier">port</span><span class="ruby-operator">|</span>&#x000A;      <span class="ruby-ivar">@session</span>.<span class="ruby-identifier">forward</span>.<span class="ruby-identifier">cancel_local</span>(<span class="ruby-identifier">lport</span>)&#x000A;    <span class="ruby-keyword">end</span>&#x000A;  <span class="ruby-keyword">end</span>&#x000A;&#x000A;  <span class="ruby-ivar">@active</span> = <span class="ruby-keyword">false</span>&#x000A;  &#x000A;  <span class="ruby-ivar">@thread</span>.<span class="ruby-identifier">join</span>&#x000A;  <span class="ruby-ivar">@session</span>.<span class="ruby-identifier">close</span>&#x000A;<span class="ruby-keyword">end</span></pre>
                </div>
              </div>
              <div class='method public-instance' id='method-method-i-ssh'>
                <a name='method-i-ssh'></a>
                <div class='synopsis'>
                  <span class='name'>ssh</span>
                  <span class='arguments'>(host, user, options={}, &block)</span>
                </div>
                <div class='description'>
                  
                  <p>Forwards a new connection to the given <code>host</code> and opens a new <a
                  href="../SSH.html">Net::SSH</a> connection to that host over the forwarded
                  port. If a block is given, the new <a href="../SSH.html">SSH</a> connection
                  will be yielded to the block, and autoclosed when the block terminates. The
                  forwarded port will be autoclosed as well. If no block was given, the new
                  <a href="../SSH.html">SSH</a> connection will be returned, and it is up to
                  the caller to terminate both the connection and the forwarded port when
                  done.</p>
                  
                  <pre class="ruby"><span class="ruby-identifier">gateway</span>.<span class="ruby-identifier">ssh</span>(<span class="ruby-string">'host'</span>, <span class="ruby-string">'user'</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">ssh</span><span class="ruby-operator">|</span>&#x000A;  <span class="ruby-comment"># ...</span>&#x000A;<span class="ruby-keyword">end</span>&#x000A;&#x000A;<span class="ruby-identifier">ssh</span> = <span class="ruby-identifier">gateway</span>.<span class="ruby-identifier">ssh</span>(<span class="ruby-string">'host'</span>, <span class="ruby-string">'user'</span>)&#x000A;<span class="ruby-comment"># ...</span>&#x000A;<span class="ruby-identifier">ssh</span>.<span class="ruby-identifier">close</span>&#x000A;<span class="ruby-identifier">gateway</span>.<span class="ruby-identifier">close</span>(<span class="ruby-identifier">ssh</span>.<span class="ruby-identifier">transport</span>.<span class="ruby-identifier">port</span>)</pre>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('method-i-ssh-source'); return false">
                    [show source]
                  </a>
                  <pre id='method-i-ssh-source'><span class="ruby-comment"># File lib/net/ssh/gateway.rb, line 170</span>&#x000A;<span class="ruby-keyword">def</span> <span class="ruby-identifier">ssh</span>(<span class="ruby-identifier">host</span>, <span class="ruby-identifier">user</span>, <span class="ruby-identifier">options</span>={}, &amp;<span class="ruby-identifier">block</span>)&#x000A;  <span class="ruby-identifier">local_port</span> = <span class="ruby-identifier">open</span>(<span class="ruby-identifier">host</span>, <span class="ruby-identifier">options</span>[<span class="ruby-value">:port</span>] <span class="ruby-operator">||</span> <span class="ruby-value">22</span>)&#x000A;&#x000A;  <span class="ruby-keyword">begin</span>&#x000A;    <span class="ruby-constant">Net</span><span class="ruby-operator">::</span><span class="ruby-constant">SSH</span>.<span class="ruby-identifier">start</span>(<span class="ruby-string">&quot;127.0.0.1&quot;</span>, <span class="ruby-identifier">user</span>, <span class="ruby-identifier">options</span>.<span class="ruby-identifier">merge</span>(<span class="ruby-value">:port</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">local_port</span>), &amp;<span class="ruby-identifier">block</span>)&#x000A;  <span class="ruby-keyword">ensure</span>&#x000A;    <span class="ruby-identifier">close</span>(<span class="ruby-identifier">local_port</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">block</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">$!</span>&#x000A;  <span class="ruby-keyword">end</span>&#x000A;<span class="ruby-keyword">end</span></pre>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div id='footer-push'></div>
    </div>
    <div id='footer'>
      <a target="docwin" href="http://github.com/mislav/hanna/tree/master"><strong>Hanna</strong> RDoc template</a>
    </div>
  </body>
</html>
